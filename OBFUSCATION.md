# ابهام‌سازی ترافیک در Backhaul (Obfuscation)

## نمای کلی
Backhaul برای عبور از DPI (بازرسی عمیق بسته) و سامانه‌های فیلترینگ، لایه‌های ابهام‌سازی چندگانه ارائه می‌دهد تا ترافیک شما تا حد امکان شبیه ترافیک واقعی HTTPS/WebSocket از سمت مرورگرها دیده شود.

## لایه‌های ابهام‌سازی

### 1) ابهام‌سازی ترافیک HTTPS
در حالت‌های مبتنی بر وب‌سوکت (WS/WSS/W(S)MUX)، کلاینت هدرهای HTTP واقع‌نما تولید می‌کند:
- چرخش User-Agent بین رشته‌های واقعی مرورگرها
- افزودن هدرهای متداول مانند `Accept`, `Accept-Language`, `Accept-Encoding`, `DNT`, `Connection` و …
- پشتیبانی از هدرهای امنیتی مدرن مانند خانواده `Sec-Fetch-*`
- پشتیبانی از هدرهای سفارشی برای ابهام‌سازی بیشتر

### 2) ابهام‌سازی مسیرهای WebSocket
به‌جای مسیرهای قابل‌حدس مانند `/channel`، مسیرهای واقع‌نما استفاده می‌شود:
- مسیرهایی مانند `/api/v1/stream`, `/cdn/assets`, `/ws/chat`, `/api/notifications`, `/live/stream`, `/api/analytics`, `/cdn/static`, `/api/status`, `/ws/updates`, `/api/metrics`
- مسیرهای پویا (برای هر اتصال یک مسیر یکتا با شناسه تصادفی)
- سازگاری خودکار سمت سرور برای پذیرش مسیرهای مبهم

### 3) ابهام‌سازی اثرانگشت TLS (TLS Fingerprinting)
به‌روزرسانی پیکربندی TLS برای کاهش قابلیت انگشت‌نگاری:
- استفاده از نسخه‌های مدرن TLS (1.2 و 1.3)
- منحنی‌های استاندارد X25519 و P-256
- تنظیمات نزدیک به رفتار مرورگرهای رایج

## پیکربندی

### تنظیمات پیش‌فرض
ابهام‌سازی برای حالت‌های مبتنی بر وب‌سوکت به‌صورت پیش‌فرض فعال است. پیکربندی در کد کلاینت (ماژول‌های WS/WSS) اعمال می‌شود و نیاز به تنظیم دستی ابتدایی ندارد. در صورت نیاز، می‌توانید هدرهای سفارشی خود را اضافه کنید.

### مجموعه User-Agent
مجموعه‌ای متنوع از رشته‌های User-Agent واقعی از مرورگرهای زیر در نظر گرفته می‌شود:
- Chrome (نسخه‌ها و پلتفرم‌های مختلف: Windows/macOS/Linux/Android)
- Firefox (نسخه‌ها و پلتفرم‌های مختلف)
- Safari (نسخه‌های macOS و iOS)
- Edge (Windows و macOS)

### مسیرهای واقع‌نما
نمونه مسیرهای از پیش تعریف‌شده برای ابهام‌سازی:
- `/api/v1/stream`, `/cdn/assets`, `/ws/chat`, `/api/notifications`, `/live/stream`, `/api/analytics`, `/cdn/static`, `/api/status`, `/ws/updates`, `/api/metrics`

## نحوه کارکرد

### سمت کلاینت
1) شروع اتصال WebSocket:
   - تولید شناسه تصادفی کاربر
   - انتخاب تصادفی User-Agent از مخزن موجود
   - ایجاد هدرهای HTTP واقعی و قابل‌قبول
   - استفاده از مسیر وب‌سوکت مبهم به‌جای مسیرهای قابل‌حدس
2) دست‌دهی TLS در WSS:
   - استفاده از تنظیمات TLS مدرن
   - اتخاذ منحنی‌های رایج مرورگرها
   - کاهش احتمال تشخیص از طریق اثرانگشت TLS

### سمت سرور
1) تشخیص مسیرهای مبهم و پذیرش آن‌ها
2) پردازش هدرهای واقعی با رعایت اصول امنیتی
3) سازگاری با کلاینت‌های مبهم‌سازی‌شده و حتی کلاینت‌های ساده

## مزایا
### ضدتشخیص
- عبور از DPI: شباهت به ترافیک وب معتبر
- کاهش انگشت‌نگاری: کاهش احتمال تشخیص از طریق TLS/HTTP fingerprinting
- ابهام رفتاری: شبیه‌سازی الگوهای رفتاری مرورگر

### انعطاف‌پذیری
- سازگاری عقب‌رو با کلاینت‌های بدون ابهام‌سازی
- قابل‌پیکربندی و قابل‌گسترش

## ملاحظات امنیتی
### نقاط قوت
- تاب‌آوری در برابر سانسور: شانس بیشتر برای عبور از فیلترها
- بهبود حریم خصوصی: کاهش تحلیل الگوهای ترافیکی
- عملیت پنهان‌کارانه‌تر

### محدودیت‌ها
- هیچ روشی کامل نیست؛ DPIهای پیشرفته ممکن است همچنان قادر به تشخیص باشند
- سربار پردازشی اندک دارد
- نیاز دوره‌ای به به‌روزرسانی مجموعه User-Agent ها

## مثال‌های استفاده

### استفاده پایه (کلاینت WSS)
```toml
[client]
transport   = "wss"
remote_addr = "example.com:443"
token       = "YOUR_TOKEN"
```

### افزودن هدرهای سفارشی (نمونه مفهومی)
Pseudo-code در کلاینت وب‌سوکت برای افزودن هدرهای سفارشی:
```go
customHeaders := map[string]string{
    "X-Forwarded-For": "203.0.113.1",
    "X-Real-IP":       "203.0.113.1",
}
// این هدرها به درخواست‌های WS اضافه می‌شوند (بسته به پیاده‌سازی کلاینت WS)
```

## مانیتورینگ و لاگ‌ها

### لاگ‌های کلاینت
در سطح Trace/Debug ممکن است اطلاعات مربوط به مسیر مبهم و UA انتخابی ثبت شود، مثل:
```
TRACE using obfuscated path: /api/v1/stream/12345
TRACE using User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) ...
```

### لاگ‌های سرور
پذیرش مسیرهای مبهم در سطح Trace/Debug ثبت می‌شود، مانند:
```
TRACE received request for path: /api/v1/stream/12345
TRACE detected obfuscated path: /api/v1/stream/12345
```

## بهبودهای آینده (پیشنهادی)
1) Domain Fronting (سازگار با CDN) در برخی سناریوها
2) تقلید پروتکل‌های دیگر (HTTP/2, gRPC)
3) Traffic Shaping برای الگوهای رفتاری واقع‌نما
4) Certificate Pinning (پین‌کردن گواهی)
5) ابهام‌سازی چندلایه و ترکیبی

## مشارکت
برای افزودن تکنیک‌های جدید ابهام‌سازی:
1) ساختار پیکربندی ابهام‌سازی را توسعه دهید
2) منطق ابهام‌سازی را پیاده‌سازی کنید
3) تست‌های مناسب بنویسید
4) این مستند را به‌روزرسانی کنید

## جمع‌بندی
لایه‌های ابهام‌سازی Backhaul توان عبور در شبکه‌های محدود را بدون قربانی‌کردن سازگاری و کارایی، به‌صورت معناداری افزایش می‌دهند. با شبیه‌سازی ترافیک مرورگر و تنظیمات TLS/HTTP واقع‌نما، احتمال تشخیص توسط سامانه‌های DPI کاهش می‌یابد؛ با این حال، توصیه می‌شود در کنار ابهام‌سازی، از راهکارهای امنیتی مکمل و روش‌های استقرار امن نیز استفاده شود.
